name: due-soon-reminder

on:
  schedule:
    # Runs 00:00 UTC daily (09:00 Asia/Seoul)
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  issues: write

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Scan open issues and comment if due soon / overdue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });

            function parseDue(body) {
              if (!body) return null;
              const m = body.match(/ğŸ“…\s*ë§ˆê°ì¼[:\s]*([0-9]{4}-[0-9]{2}-[0-9]{2})/);
              return m ? m[1] : null;
            }

            const today = new Date(); // UTC now
            const ymd = d => d.toISOString().slice(0,10);

            for (const issue of issues) {
              const dueStr = parseDue(issue.body);
              if (!dueStr) continue;

              const due = new Date(dueStr + "T23:59:59Z");
              const daysLeft = Math.floor((due - today) / (1000*60*60*24));

              let comment = null;
              let addLabel = null;
              if (daysLeft === 1) {
                comment = `â° **D-1**: ë‚´ì¼(\`${dueStr}\`) ë§ˆê°ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ë°˜ë“œì‹œ ë§ˆë¬´ë¦¬í•©ì‹œë‹¤!`;
                addLabel = "due-soon";
              } else if (daysLeft === 0) {
                comment = `ğŸš¨ **D-day**: ì˜¤ëŠ˜(\`${dueStr}\`) ë§ˆê°! ë§ˆì§€ë§‰ ì ê²€í•´ì£¼ì„¸ìš”.`;
                addLabel = "due-soon";
              } else if (daysLeft < 0) {
                comment = `âš ï¸ **ì§€ì—°**: ë§ˆê°(\`${dueStr}\`)ì„ ì§€ë‚¬ìŠµë‹ˆë‹¤. ìš°ì„ ìˆœìœ„ë¥¼ ì¬ì¡°ì •í•˜ê³  ì²˜ë¦¬í•´ì£¼ì„¸ìš”.`;
                addLabel = "overdue";
              }

              if (comment) {
                // Ensure label exists on the repo
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: [addLabel]
                  });
                } catch (e) {
                  // ignore if label doesn't exist; recommend running bootstrap
                  core.warning(`Label add failed: ${e.message}`);
                }

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: comment
                });
              }
            }
